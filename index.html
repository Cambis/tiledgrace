<!DOCTYPE html>
<html>
 <head>
     <meta charset="UTF-8">
     <title>Gratch</title>
     <link rel="stylesheet" type="text/css" href="style.css">
 </head>
 <body>
     <div id="codearea">
         <div id="bin">&#59177;</div>
     </div>
     <div id="toolbox">
         <div class="tile vardec" data-category="Variables"><span style="margin-right: 1ex; color: blue;">var</span><input type="text" value="" size="1" class="variable-name"><span style="margin-left: 1ex; margin-right: 1ex; color: #687687;">:=</span><div class="hole"></div></div>
         <div class="tile var" data-category="Variables"><span class="var-name"></span></div>
         <div class="tile assign" data-category="Variables"><div class="hole"></div><span style="margin-left: 1ex; margin-right: 1ex; color: #687687;">:=</span><div class="hole"></div></div>
         <div class="tile operator" data-category="Numbers and Strings"><div class="hole number"></div><div class="op" data-operators="+ * - /">+</div><div class="hole number"></div></div>
         <div class="tile comparison-operator" data-category="Numbers and Strings"><div class="hole number"></div><div class="cmpop">==</div><div class="hole number"></div></div>
         <div class="tile number" data-category="Numbers and Strings"><input type="text" value="0" size="3" ></div>
         <div class="tile operator iterable" data-category="Numbers and Strings"><div class="hole number"></div><div class="op">..</div><div class="hole number"></div></div>
         <div class="tile string" data-category="Numbers and Strings">"<input type="text" value="Hello, world!" size="13" >"</div>
         <div class="tile request" data-category="Control"><div class="hole"></div><span>.</span><input type="text" size="5"></div>
         <div class="tile method" data-category="Control"><div><span style="margin-right: 1ex; color: blue;">method</span><input type="text" value="" size="5" />(<input type="text" value="" size="1" class="variable-name" />) {</div><div class="indent"><div class="hole multi"></div></div><div>}</div></div>
         <div class="tile selfcall" data-category="Control"><input type="text" size="5" />(<div class="hole"></div>)</div>
     </div>
     <div id="category-bar">
         <input type="button" value="Variables" />
         <input type="button" value="Numbers and Strings" />
         <input type="button" value="I/O" />
         <input type="button" value="Control" />
         <input type="button" value="Turtle" />
     </div>
     <canvas id="standard-canvas" width="250" height="500"></canvas>
     <br />
     <select id="dialect" onchange="changeDialect()">
         <option value="">Standard
         <option value="logo">Turtle graphics
         <option value="loopinvariant">Loop invariants
     </select>
     <input type="button" onclick="go()" value="Run">
     <input type="button" onclick="toggleShrink()" value="Code View">
     <div id="indicator" style="display: inline-block; width: 16px; height: 16px; background: white;"></div>
     <a download="myprogram.grace" id="downloadlink">Download</a>
     Load file: <input type="file" id="userfile" onchange="loadFile()" />
     <br />
     <textarea id="stdout_txt" style="clear:both;" cols="100" rows="5"></textarea>
     <br /><textarea id="stderr_txt" style="clear:both;" cols="100" rows="5"></textarea><br />
     <textarea id="gracecode" cols="100" rows="10"></textarea><br />
     <canvas id="overlay-canvas" width="500" height="500"></canvas>
     <script type="text/javascript" src="main.js"></script>
     <script type="text/javascript" src="json.js"></script>
     <script type="text/javascript" src="dialects.js"></script>
     <script type="text/javascript" src="minigrace.js"></script>
     <script type="text/javascript" src="turtle.js"></script>
     <script type="text/javascript" src="logo.js"></script>
     <script type="text/javascript" src="loopinvariant.js"></script>
     <script type="text/javascript">
        var getCode = function() {
            if (codearea.classList.contains("shrink"))
                return editor.getValue();
            return document.getElementById('gracecode').value;
        }

        // Setup stderr.
        minigrace.stderr_write = function(value) {
            var stderr = document.getElementById("stderr_txt");
            stderr.value += value;
            stderr.scrollTop = stderr.scrollHeight;
        };

        // Setup stdout.
        minigrace.stdout_write = function(value) {
            var stdout = document.getElementById("stdout_txt");
            stdout.value += value;
            stdout.scrollTop = stdout.scrollHeight;
        };

        function go() {
            if (!codearea.classList.contains('shrink')) {
                if (highlightEmptyHoles())
                    return;
            }
            generateCode();
            document.getElementById('stderr_txt').value = "";
            document.getElementById('stdout_txt').value = "";
            minigrace.modname = "main";
            minigrace.compilerun(getCode());
        }
        if (window.location.hash) {
            var obj = loadJSON(decodeURIComponent((atob(window.location.hash.substring(1)))));
            history.replaceState(obj, "", generateHash(obj));
        } else if (localStorage.getItem("autosave-json")) {
            var obj = loadJSON(localStorage.getItem("autosave-json"));
            history.replaceState(obj, "", generateHash(obj));
        }
var gctCache = {
    'logo': "modules:\n StandardPrelude\npath:\n logo\nclasses:\npublic:\n red\n green\n blue\n black\n lineWidth\n lineWidth:=\n lineColor\n lineColor:=\n angle\n angle:=\n forward\n turnRight\n turnLeft\n atModuleEnd\nconfidential:\nfresh-methods:\n",
    'loopinvariant': "modules:\n StandardPrelude\npath:\n logo\nclasses:\npublic:\n if()then()else\n if()then\n for()invariant()do\n while()invariant()do\nconfidential:\nfresh-methods:\n"
};
    </script>
    <div id="code_txt_real"></div>
    <script src="ace/ace.js"></script>
    <script src="ace/mode-grace.js" type="text/javascript" charset="utf-8"></script>
    <script>
        var bgMinigrace = new Worker("background.js");
        if (ace) {
           document.getElementById('code_txt_real').style.display = 'block';
           var editor = ace.edit("code_txt_real");
           var GraceMode = require("ace/mode/grace").Mode;
           editor.getSession().setMode(new GraceMode());
           editor.setBehavioursEnabled(false);
           editor.setHighlightActiveLine(true);
           editor.setShowFoldWidgets(false);
           editor.setShowPrintMargin(false);
           editor.getSession().setUseSoftTabs(true);
           editor.getSession().setTabSize(4);
           editor.setFontSize('16px');
           editor.commands.bindKeys({"ctrl-l":null, "ctrl-shift-r":null, "ctrl-r":null, "ctrl-t":null})
           editor.on('mousemove', function(e) {
               var position = e.getDocumentPosition();
               var token = editor.session.getTokenAt(position.row, position.column);
               if (token && token.type == 'identifier') {
                   drawVarLinesOverText(e);
               } else {
                   document.getElementById('overlay-canvas').getContext('2d').clearRect(0, 0, 500, 500);
               }
           });
           var ctr = document.getElementById('code_txt_real');
           ctr.style.height = document.getElementById('codearea').clientHeight + 'px';
           ctr.style.width = (document.getElementById('codearea').clientWidth) + 'px';
           ctr.style.position = 'absolute';
           ctr.style.top = codearea.offsetTop + 'px';
           ctr.style.left = codearea.offsetLeft + 'px';
           ctr.style.visibility = 'hidden';
           var lastChange = new Date().getTime();
           var changedSinceLast = false;
           editor.on("change", function(ev) {
               lastChange = new Date().getTime();
               changedSinceLast = true;
           });
           setInterval(function() {
                if (!changedSinceLast)
                    return;
                if (!codearea.classList.contains("shrink"))
                    return;
                if (lastChange + 1000 > new Date().getTime())
                    return;
                lastChange = new Date().getTime();
                changedSinceLast = false;
                if (editor.getValue()
                    == document.getElementById('gracecode').value) {
                    document.getElementById('indicator').style.background = 'green';
                    editor.getSession().clearAnnotations();
                    return;
                }
                bgMinigrace.onmessage = function(ev) {
                    if (!ev.data.success) {
                        document.getElementById('indicator').style.background = 'red';
                        showErrorInEditor(ev.data.stderr)
                        return;
                    }
                    editor.getSession().clearAnnotations();
                    rebuildTilesInBackground(ev.data.output);
                    document.getElementById('gracecode').value = editor.getValue();
                document.getElementById('indicator').style.background = 'green';
                }
                document.getElementById('indicator').style.background = 'orange';
                bgMinigrace.postMessage({action: "compile", mode: "json",
                    modname: "main", source: editor.getValue() + chunkLine});

           }, 1000);
        }
        bgMinigrace.postMessage({action: "importFile", modname: "logo",
                url: "logo.js"});
        bgMinigrace.postMessage({action: "importFile", modname: "turtle",
                url: "turtle.js"});
        bgMinigrace.postMessage({action: "importFile",
                modname: "loopinvariant",
                url: "loopinvariant.js"});
        bgMinigrace.postMessage({action: "importGCT", modname: "logo",
            gct: gctCache['logo']});
        bgMinigrace.postMessage({action: "importGCT", modname: "loopinvariant",
            gct: gctCache['loopinvariant']});
    </script>
    <div id="acknowledgements"><a href="https://github.com/mwh/minigrace">Minigrace</a> is distributed under the GNU GPL version 3. <a href="http://www.entypo.com/">Entypo</a> pictograms by Daniel Bruce.</div>
 </body>
</html>
