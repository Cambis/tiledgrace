<!DOCTYPE html>
<html>
 <head>
     <meta charset="UTF-8">
     <title>Gratch</title>
     <style type="text/css">
        #codearea {
           width: 500px;
           height: 500px;
           background: #ddd;
           position: relative;
           float: left;
           overflow: auto;
        }
        .tile.operator {
           background: #9b9;
           border: 2px outset #060;
        }
        .tile.request {
            background: #b99;
            border: 2px outset #600;
        }
        .tile.number {
           background: #8c8;
           border: 2px outset #080;
        }
        .tile {
           padding: 1px;
           width: auto;
           height: auto;
           display: inline-flex;
           float: left;
           position: absolute;
           white-space: nowrap;
           align-items: center;
           transition: opacity 0.5s;
        }
        .tile input {
           border: none;
        }
        .selected {
           z-index: 999;
           opacity: 0.5;
           cursor: default;
        }
        .hole {
           min-width: 2em;
           padding: 1px;
           background: #aaa;
           display: inline-flex;
           width: auto;
           min-height: 12px;
        }
        #toolbox {
            background: #ccf;
            float:left;
            height: 500px;
            width: 150px;
        }
        #toolbox .tile {
            position: static;
            clear: both;
        }
        .tile .op {
            display:inline-flex;
            padding-left: 4px;
            padding-right: 4px;
            font-weight: bold;
        }
        #gracecode {
            float: left;
            width: 200px;
            height: 500px;
        }
        .tile.bottom-join-target {
            border-bottom-color: yellow;
            border-bottom-style: solid;
        }
     </style>
 </head>
 <body>
     <div id="codearea">
     </div>
     <div id="toolbox">
         <div class="tile operator"><div class="hole number"></div><div class="op">+</div><div class="hole number"></div></div>
         <div class="tile number"><input type="text" value="0" size="1" ></div>
         <div class="tile request"><div class="hole"></div><span style="display:inline-flex;">.</span><input type="text" size="5"></div>
     </div>
     <textarea id="gracecode"></textarea>
     <script type="text/javascript">
        var holes = document.getElementsByClassName('hole');
        var codearea = document.getElementById('codearea');
        var toolbox = document.getElementById('toolbox');
        function findOffsetTopLeft(el) {
            var x = el.offsetLeft;
            var y = el.offsetTop;
            if (el.offsetParent && el.offsetParent != codearea && el.offsetParent != toolbox) {
                var xy = findOffsetTopLeft(el.offsetParent);
                x = x + xy.left;
                y = y + xy.top;
            }
            return {left: x, top: y};
        }
        function isBottomTarget(ch, obj) {
            var t = ch.offsetTop + ch.offsetHeight;
            var l = ch.offsetLeft;
            var r = ch.offsetLeft + ch.offsetWidth;
            var m = obj.offsetLeft + obj.offsetWidth / 2;
            if (obj.offsetTop < t + 4 && obj.offsetTop > t - 4) {
                if (m >= l && m <= r)
                    return true;
            }
            return false;
        }
        function dragstart(ev) {
            var xy = findOffsetTopLeft(this);
            var offsetY = ev.clientY - xy.top;
            var offsetX = ev.clientX - xy.left;
            var obj = this;
            ev.preventDefault();
            var dragcontinue = function(ev2) {
                var top = (ev2.clientY - offsetY);
                var left = (ev2.clientX - offsetX);
                obj.style.top = top + 'px';
                obj.style.left = left + 'px';
                ev2.preventDefault();
                var holeSize = 1000000;
                var bestHole = null;
                for (var i=holes.length - 1; i>=0; i--) {
                    var h = holes[i];
                    h.style.background = '';
                    if (h.offsetParent == obj)
                        continue;
                    var xy = findOffsetTopLeft(h);
                    xy.top = xy.top + codearea.offsetTop;
                    xy.left = xy.left + codearea.offsetLeft;
                    if (left + offsetX < xy.left
                            || left + offsetX > xy.left + h.offsetWidth) {
                        continue;
                    }
                    if (top + offsetY < xy.top
                            || top + offsetY > xy.top + h.offsetHeight) {
                        continue;
                    }
                    if (h.offsetWidth * h.offsetHeight < holeSize) {
                        holeSize = h.offsetWidth * h.offsetHeight;
                        bestHole = h;
                    }
                }
                if (bestHole != null && bestHole.children.length == 0) {
                    bestHole.style.background = 'yellow';
                }
                var tmp = obj;
                while (typeof tmp.next != "undefined" && tmp.next) {
                    var last = tmp;
                    tmp = tmp.next;
                    tmp.style.top = (last.offsetTop + last.offsetHeight) + 'px';
                    tmp.style.left = last.offsetLeft + 'px';
                }
                for (var i=0; i<codearea.children.length; i++) {
                    var ch = codearea.children[i];
                    if (ch == obj)
                        continue;
                    if (isBottomTarget(ch, obj)) {
                        ch.classList.add('bottom-join-target');
                    } else {
                        ch.classList.remove('bottom-join-target');
                    }
                }
            }
            var d = document.getElementById('codearea');
            this.style.position = 'absolute';
            this.style.top = xy.top + 'px';
            this.style.left = xy.left + 'px';
            this.parentNode.removeChild(this);
            d.appendChild(this);
            var dragend = function(ev) {
                var top = (ev.clientY - offsetY);
                var left = (ev.clientX - offsetX);
                obj.style.top = top + 'px';
                obj.style.left = left + 'px';
                d.removeEventListener('mousemove', dragcontinue);
                d.removeEventListener('mouseup', dragend);
                obj.classList.remove('selected');
                var tmp = obj;
                while (typeof tmp.next != "undefined" && tmp.next) {
                    tmp = tmp.next;
                    tmp.classList.remove('selected');
                }
                var holeSize = 1000000;
                var bestHole = null;
                for (var i=holes.length - 1; i>=0; i--) {
                    var h = holes[i];
                    if (h.offsetParent == obj)
                        continue;
                    var xy = findOffsetTopLeft(h);
                    xy.top = xy.top + codearea.offsetTop;
                    xy.left = xy.left + codearea.offsetLeft;
                    if (left + offsetX < xy.left
                            || left + offsetX > xy.left + h.offsetWidth) {
                        continue;
                    }
                    if (top + offsetY < xy.top
                            || top + offsetY > xy.top + h.offsetHeight) {
                        continue;
                    }
                    if (h.offsetWidth * h.offsetHeight < holeSize) {
                        holeSize = h.offsetWidth * h.offsetHeight;
                        bestHole = h;
                    }
                }
                if (bestHole != null) {
                    if (bestHole.children.length == 0) {
                        obj.style.top = 0;
                        obj.style.left = 0;
                        obj.style.position = 'static';
                        bestHole.appendChild(obj);
                        bestHole.style.background = '';
                    }
                }
                for (var i=0; i<codearea.children.length; i++) {
                    var ch = codearea.children[i];
                    if (ch == obj)
                        continue;
                    var t = ch.offsetTop + ch.offsetHeight;
                    if (isBottomTarget(ch, obj)) {
                        if (ch.next) {
                            ch.next.prev = obj;
                            obj.next = ch.next;
                        }
                        ch.next = obj;
                        ch.classList.remove('bottom-join-target');
                        obj.prev = ch;
                        obj.style.left = ch.offsetLeft + 'px';
                        obj.style.top = t + 'px';
                        var tmp = ch;
                        while (tmp.next) {
                            var last = tmp;
                            tmp = tmp.next;
                            tmp.style.top = (last.offsetTop + last.offsetHeight) + 'px';
                            tmp.style.left = last.offsetLeft + 'px';
                        }
                        break;
                    }
                }
                generateCode();
            }
            d.addEventListener('mousemove', dragcontinue)
            d.addEventListener('mouseup', dragend)
            this.classList.add('selected');
            var tmp = this;
            while (typeof tmp.next != "undefined" && tmp.next) {
                tmp = tmp.next;
                tmp.classList.add('selected');
            }
            if (typeof this.prev != "undefined" && this.prev) {
                this.prev.next = false;
                this.prev = false;
            }
            ev.stopPropagation();
        }
        function generateNodeCode(n) {
            if (typeof n == 'undefined' || typeof n == 'boolean')
                return '!ABSENT!';
            if (n.classList.contains('number')) {
                return n.getElementsByTagName('input')[0].value;
            }
            if (n.classList.contains('request')) {
                return generateNodeCode(n.children[0].children[0]) + '.' + n.children[2].value;
            }
            if (n.classList.contains('operator')) {
                var l = false;
                var r = false;
                var op = '';
                for (var i=0; i<n.children.length; i++) {
                    var c = n.children[i];
                    if (c.classList.contains('hole')) {
                        if (l) {
                            r = c.children[0];
                            break;
                        } else {
                            l = c.children[0];
                        }
                    }
                    if (c.classList.contains('op')) {
                        op = c.innerHTML;
                    }
                }
                return '(' + generateNodeCode(l) + ' ' + op + ' ' + generateNodeCode(r) + ')';
            }
        }
        function generateCode() {
            var tb = document.getElementById('gracecode');
            tb.value = '';
            for (var i=0; i<codearea.children.length; i++) {
                var child = codearea.children[i];
                if (child.prev != false)
                    continue;
                while (child) {
                    tb.value = tb.value + generateNodeCode(child) + '\n';
                    child = child.next;
                }
            }
        }
        function attachTileBehaviour(n) {
            n.addEventListener('mousedown', dragstart);
            n.next = false;
            n.prev = false;
            Array.prototype.forEach.call(n.getElementsByTagName('input'),
                    function(el) {
                        el.addEventListener('mousedown', function(ev) {
                            ev.stopPropagation();
                        });
                    });
            Array.prototype.forEach.call(n.getElementsByClassName('op'),
                    function(el) {
                        el.addEventListener('dblclick', function(ev) {
                            switch(this.innerHTML) {
                                case "*":
                                    this.innerHTML = '-';
                                    break;
                                case "-":
                                    this.innerHTML = '/';
                                    break;
                                case "/":
                                    this.innerHTML = '++';
                                    break;
                                case "++":
                                    this.innerHTML = '+';
                                    break;
                                default:
                                    this.innerHTML = '*';
                            }
                        });
                    });
        }
        function attachHoleBehaviour(n) {
            n.addEventListener('mouseup', holedrop);
            n.addEventListener('mousemove', function(){alert("entering");});
        }
        function attachToolboxBehaviour(n) {
            n.addEventListener('mousedown', function(ev) {
                var cl = this.cloneNode();
                codearea.appendChild(cl);
                cl.style.position = 'absolute';
                cl.style.top = (this.offsetTop - toolbox.offsetTop) + 'px';
                cl.style.left = '500px';
                attachTileBehaviour(cl);
                dragstart.call(cl, ev);
            });
        }
        Array.prototype.forEach.call(codearea.getElementsByClassName('tile'),
                attachTileBehaviour);
        Array.prototype.forEach.call(toolbox.getElementsByClassName('tile'),
                attachToolboxBehaviour);
     </script>
 </body>
</html>
